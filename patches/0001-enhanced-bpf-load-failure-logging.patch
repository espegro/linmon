From: LinMon Security Team <security@linmon.org>
Date: Sun, 5 Jan 2026 12:00:00 +0000
Subject: [PATCH] Enhanced BPF load failure logging for rootkit detection

When BPF programs fail to load (e.g., blocked by Singularity rootkit),
LinMon now:
1. Logs CRITICAL alert to syslog (persistent)
2. Creates /var/log/linmon/CRITICAL_BPF_LOAD_FAILED marker file
3. Provides actionable error messages
4. Mentions possible rootkit interference

This ensures administrators are alerted even if the daemon exits
without initializing its JSON logger.

Signed-off-by: LinMon Security Team <security@linmon.org>
---
 src/main.c | 57 ++++++++++++++++++++++++++++++++++++++++++++++++++++--
 1 file changed, 55 insertions(+), 2 deletions(-)

diff --git a/src/main.c b/src/main.c
index 1234567..abcdefg 100644
--- a/src/main.c
+++ b/src/main.c
@@ -930,11 +930,64 @@ int main(int argc, char **argv)
     // Initialize filter
     filter_init(&global_config);

-    // Load and open BPF application
+    // Load and open BPF application (CRITICAL SECURITY CHECKPOINT)
+    // If this fails, it may indicate:
+    // 1. Kernel rootkit blocking bpf() syscall (e.g., Singularity)
+    // 2. Missing kernel BTF support
+    // 3. Insufficient privileges
     skel = linmon_bpf__open_and_load();
     if (!skel) {
-        fprintf(stderr, "Failed to open/load LinMon BPF programs\n");
+        // Get error details
+        int bpf_errno = errno;
+        const char *error_msg = strerror(bpf_errno);
+
+        // CRITICAL: Log to syslog IMMEDIATELY (survives daemon exit)
+        // This ensures we have persistent evidence of BPF load failures
+        syslog(LOG_CRIT, "CRITICAL: Failed to load BPF programs: %s (errno=%d). "
+                         "This may indicate kernel rootkit interference (e.g., Singularity rootkit). "
+                         "LinMon cannot start without BPF support. "
+                         "Verify: 1) Kernel version >= 5.8, 2) BTF enabled (/sys/kernel/btf/vmlinux exists), "
+                         "3) No rootkit blocking bpf() syscall. Check dmesg for details.",
+               error_msg, bpf_errno);
+
+        // Also log to stderr for systemd journal
+        fprintf(stderr, "\n");
+        fprintf(stderr, "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
+        fprintf(stderr, "â•‘  CRITICAL: LinMon BPF Program Loading FAILED                 â•‘\n");
+        fprintf(stderr, "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
+        fprintf(stderr, "\n");
+        fprintf(stderr, "Error: %s (errno=%d)\n", error_msg, bpf_errno);
+        fprintf(stderr, "\n");
+        fprintf(stderr, "This failure may indicate:\n");
+        fprintf(stderr, "  1. ğŸš¨ KERNEL ROOTKIT blocking bpf() syscall\n");
+        fprintf(stderr, "     â†’ Singularity-type attack in progress\n");
+        fprintf(stderr, "     â†’ Check: dmesg | grep -iE '(singularity|rootkit|module)'\n");
+        fprintf(stderr, "     â†’ Check: lsmod | grep -iE '(singularity|rootkit)'\n");
+        fprintf(stderr, "\n");
+        fprintf(stderr, "  2. Missing kernel BTF support\n");
+        fprintf(stderr, "     â†’ Check: ls /sys/kernel/btf/vmlinux\n");
+        fprintf(stderr, "     â†’ If missing, rebuild kernel with CONFIG_DEBUG_INFO_BTF=y\n");
+        fprintf(stderr, "\n");
+        fprintf(stderr, "  3. Insufficient privileges\n");
+        fprintf(stderr, "     â†’ LinMon requires: CAP_BPF, CAP_PERFMON, CAP_NET_ADMIN\n");
+        fprintf(stderr, "     â†’ Check: getcap /usr/local/sbin/linmond\n");
+        fprintf(stderr, "\n");
+        fprintf(stderr, "For rootkit investigation:\n");
+        fprintf(stderr, "  sudo dmesg | tail -50\n");
+        fprintf(stderr, "  sudo lsmod | grep lkrg\n");
+        fprintf(stderr, "  sudo journalctl -u linmond --since '10 minutes ago'\n");
+        fprintf(stderr, "\n");
+
+        // Create persistent alert file (survives daemon exit)
+        const char *alert_file = "/var/log/linmon/CRITICAL_BPF_LOAD_FAILED";
+        FILE *alert_fp = fopen(alert_file, "w");
+        if (alert_fp) {
+            fprintf(alert_fp, "LinMon BPF loading failed at %s\n", ctime(&daemon_start_time));
+            fprintf(alert_fp, "Error: %s (errno=%d)\n", error_msg, bpf_errno);
+            fprintf(alert_fp, "Possible rootkit interference detected.\n");
+            fprintf(alert_fp, "Investigate: dmesg | grep -iE '(bpf|module|LKRG|singularity)'\n");
+            fclose(alert_fp);
+        }
+
         err = -1;
         goto cleanup;
     }
--
2.34.1
