# ============================================================================
# LinMon Configuration File
# ============================================================================
# Copy to /etc/linmon/linmon.conf and customize for your environment
#
# LinMon is an eBPF-based system monitoring tool for Linux, similar to
# Sysmon for Windows. It logs process execution, file operations, network
# activity, and privilege escalation events.

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================

# Path to JSON event log file
# Events are logged in JSON Lines format (one JSON object per line)
log_file = /var/log/linmon/events.json

# Enable logging ALL events to syslog (in addition to JSON file)
# true  = All events are logged to both JSON file AND syslog/journald
#         Useful for: Central log management, SIEM integration, audit compliance
# false = Only daemon lifecycle events go to syslog (default)
#         Normal events still go to JSON file
# Note: Daemon lifecycle events (start/stop/reload) are ALWAYS logged to syslog
# for tamper detection, regardless of this setting.
# Warning: Enabling this may generate significant syslog volume on busy systems
log_to_syslog = false

# ============================================================================
# BUILT-IN LOG ROTATION
# ============================================================================
# LinMon includes built-in log rotation that is ON by default.
# Disable this if you prefer to use external logrotate.

# Enable built-in log rotation
# true  = LinMon rotates logs automatically (default)
# false = Disable for external logrotate (use linmond.logrotate)
# When disabled, LinMon still handles SIGHUP to reopen log file after rotation
log_rotate = true

# Maximum log file size before rotation
# Supports suffixes: K (KB), M (MB), G (GB)
# Examples: 50M, 100M, 1G
# Minimum: 1M
# Default: 100M
log_rotate_size = 100M

# Number of rotated log files to keep
# Rotation pattern: events.json -> events.json.1 -> events.json.2 -> ...
# Oldest files are deleted when count is exceeded
# Range: 1-100
# Default: 10
log_rotate_count = 10

# Verbosity level (0=quiet, 1=normal, 2=verbose)
verbosity = 1

# ============================================================================
# MONITORING CONFIGURATION
# ============================================================================

# Monitor process execution and termination
# Logs: process_exec, process_exit events
monitor_processes = true

# Monitor process exit events
# true  = Log both exec and exit events
# false = Only log exec events (reduces noise from thread cleanup)
# Note: Requires monitor_processes = true
monitor_process_exit = true

# Monitor file operations (create, modify, delete)
# Warning: Can generate significant event volume
# Logs: file_create, file_modify, file_delete events
monitor_files = false

# Monitor TCP connections (connect/accept)
# Logs: net_connect_tcp, net_accept_tcp events
# Supports both IPv4 and IPv6
monitor_tcp = true

# Monitor UDP traffic (sendmsg)
# Warning: UDP can be VERY noisy (DNS, NTP, DHCP, mDNS, etc.)
# Only enable if you need comprehensive network monitoring
# Logs: net_send_udp events
# Supports both IPv4 and IPv6
monitor_udp = false

# Monitor vsock (Virtual Socket) connections
# vsock is used for VM-to-host and container-to-host communication
# Logs: net_vsock_connect events with CID (Context ID) instead of IP addresses
# Use case: Detect container escape attempts (T1611), VM-based C2, lateral movement
# Note: CID 2 is typically the host, CID 3+ are VMs/containers
# Default: false (only enable in VM/container environments)
monitor_vsock = false

# ============================================================================
# FILTERING CONFIGURATION
# ============================================================================

# UID filtering - only log events from users with UID >= min_uid
# Examples:
#   0    = Log all users including root and system users (RECOMMENDED for security)
#   1000 = Ignore system users, only log human users (reduces noise)
#   500  = Ignore system users (typical for RHEL/CentOS older versions)
# Default: 0 (monitor all users including root - important for security)
# Note: Set to 1000 if you want to reduce noise from system services
min_uid = 0

# Maximum UID to monitor (0 = no limit)
# Use this to exclude high UID ranges if needed
max_uid = 0

# Require controlling TTY (terminal session)
# true  = Only log processes started from terminal (ssh, local terminal)
#         Good for: Auditing interactive user sessions
# false = Log all processes including GUI apps, desktop launchers, systemd services
#         Good for: Complete monitoring (Sysmon-like behavior)
# Recommendation: false for production monitoring
require_tty = false

# Ignore threads (only log main processes)
# true  = Only log main processes (pid == tgid), filter out threads
#         Good for: Reducing noise from Firefox/Chrome thread pools
# false = Log both main processes and threads
# Default: false (log everything for complete visibility)
# Note: Set to true on desktop systems to reduce browser thread noise
ignore_threads = false

# ============================================================================
# PROCESS FILTERING
# ============================================================================

# Process name blacklist (comma-separated, exact match)
# Use this to reduce noise from chatty processes
# Examples:
#   ignore_processes = systemd,dbus-daemon,cron
#   ignore_processes = chrome,firefox,slack
ignore_processes =

# Process name whitelist (comma-separated, only log these if set)
# Leave empty to log all processes (subject to other filters above)
# Use this for focused monitoring of specific processes
# Example: only_processes = sshd,sudo,bash
only_processes =

# ============================================================================
# NETWORK & FILE PATH FILTERING
# ============================================================================

# Network CIDR filtering (comma-separated IPv4 CIDR blocks to ignore)
# Events TO these destination networks will be dropped in kernel before userspace
# Note: Only filters on destination address, not source
# Note: IPv4 only - IPv6 CIDR filtering not yet implemented
# Common examples:
#   10.0.0.0/8        - Private class A
#   172.16.0.0/12     - Private class B
#   192.168.0.0/16    - Private class C
#   127.0.0.0/8       - Loopback
#   169.254.0.0/16    - Link-local
# Leave empty to log all network traffic
# Example for common private networks:
#   ignore_networks = 127.0.0.0/8,192.168.0.0/16,10.0.0.0/8
ignore_networks =

# File path filtering (comma-separated path prefixes to ignore)
# Supports prefix matching - any file starting with these paths will be filtered
# Common examples:
#   /tmp/                 - All temporary files
#   /proc/                - Pseudo filesystem
#   /sys/                 - Kernel interface
#   /dev/                 - Device files
#   /var/cache/           - System cache
#   .cache/               - User cache directories
#   .local/share/Trash/   - Trash directories
# Leave empty to log all file operations (subject to monitor_files setting)
# Example:
#   ignore_file_paths = /tmp/,/proc/,/sys/,/dev/,.cache/
ignore_file_paths =

# ============================================================================
# ENRICHMENT & PRIVACY
# ============================================================================

# Capture full command-line arguments
# true  = Capture argv[] for all process_exec events
# false = Only capture process name
# Note: May contain sensitive data (passwords, tokens, API keys)
capture_cmdline = true

# Redact sensitive patterns in command lines
# Automatically removes passwords, tokens, and API keys from cmdline
# Patterns: password=, token=, api_key=, -p, --password, etc.
# Recommendation: Keep enabled if capture_cmdline is true
redact_sensitive = true

# Resolve UID to username (adds "username" field to events)
# Uses cached /etc/passwd lookups (256 entry cache)
# Minimal performance impact
resolve_usernames = true

# Calculate SHA256 hash of executed binaries
# Adds "sha256" field to process_exec events
# Uses LRU cache (1000 entries) to minimize disk I/O
# Note: Can impact performance for large binaries or high exec rate
# Recommendation: Enable for security monitoring, disable for high-volume systems
hash_binaries = true

# Verify if executed binaries belong to system packages
# Adds "package" field (package name or null) to process_exec events
# Adds "pkg_modified" field if file was modified since package install
# Uses persistent disk cache to minimize dpkg/rpm calls
# Supported: Debian/Ubuntu (dpkg), RHEL/Rocky/Fedora (rpm)
# Note: First lookup for a binary is slow (~10-50ms), subsequent lookups are fast
# Default: false (disabled due to initial lookup overhead)
verify_packages = false

# Package cache file path (used when verify_packages = true)
# Default: /var/cache/linmon/packages.cache
# pkg_cache_file = /var/cache/linmon/packages.cache

# Maximum entries in package cache (used when verify_packages = true)
# Range: 100-1000000
# Default: 10000
# pkg_cache_size = 10000

# Capture container metadata (runtime, ID, pod ID) from /proc/<pid>/cgroup
# Adds "container" field (sparse - only for containerized processes) to all events
# Supports: Docker, Podman, containerd, LXC, systemd-nspawn, Kubernetes
# Minimal performance impact (~0.1ms per event for containerized processes)
# Note: No overhead for host processes (namespace check is in eBPF)
# Recommendation: Keep enabled for container environments
# Default: true
capture_container_metadata = true

# ============================================================================
# TAMPER DETECTION & INTEGRITY MONITORING
# ============================================================================

# Periodic integrity checkpoint interval (minutes)
# LinMon logs periodic checkpoints to syslog/journald with:
#   - Event sequence number and count (detect deleted events)
#   - LinMon binary SHA256 hash (detect daemon replacement)
#   - Config file SHA256 hash (detect unauthorized config changes)
# Checkpoints are logged to both JSON and syslog for tamper detection
# Range: 0-1440 minutes (0 = disabled, max 24 hours)
# Default: 30 (checkpoint every 30 minutes)
# Recommendation: 15-60 minutes depending on security requirements
checkpoint_interval = 30

# ============================================================================
# EXAMPLE CONFIGURATIONS
# ============================================================================

# Minimal monitoring (interactive sessions only):
#   monitor_processes = true
#   monitor_files = false
#   monitor_tcp = false
#   monitor_udp = false
#   min_uid = 1000
#   require_tty = true

# Sysmon-like (comprehensive monitoring):
#   monitor_processes = true
#   monitor_files = true
#   monitor_tcp = true
#   monitor_udp = false
#   min_uid = 0
#   require_tty = false

# Network-focused (DNS, web traffic):
#   monitor_processes = true
#   monitor_files = false
#   monitor_tcp = true
#   monitor_udp = true
#   min_uid = 1000

# Security audit (privilege escalation focus):
#   monitor_processes = true
#   monitor_files = false
#   monitor_tcp = false
#   monitor_udp = false
#   min_uid = 0
#   only_processes = sudo,su,pkexec,doas

# ============================================================================
# SECURITY MONITORING - RECOMMENDED (Low noise, high value)
# ============================================================================
# These detections have very low false positive rates and catch critical
# attack techniques. ENABLED BY DEFAULT - recommended for all systems.

# Monitor credential/auth file reads - T1003.008, T1552.004, T1098.004
# Logs: security_cred_read events with "cred_file" field indicating type
# Detects reads of:
#   - /etc/shadow, /etc/gshadow (password hashes)
#   - /etc/sudoers, /etc/sudoers.d/* (sudo configuration)
#   - /etc/ssh/* (SSH system configuration)
#   - /etc/pam.d/* (PAM authentication configuration)
#   - ~/.ssh/id_rsa, ~/.ssh/id_ed25519, ~/.ssh/id_ecdsa (SSH private keys)
#   - ~/.ssh/authorized_keys (SSH backdoor detection)
#   - ~/.ssh/config (SSH user configuration)
# Use case: Detect credential theft, auth config reconnaissance, privilege escalation prep
# Smart filtering: Whitelists legitimate processes (login, sshd, su, sudo,
#                  passwd, useradd, sssd, nscd, polkitd, gdm, cron, etc.)
# Only logs SUSPICIOUS reads - legitimate auth processes are ignored
# Known limitation: SSH keys only detected if /.ssh/ occurs within first 22 chars of path
#   ✓ Covers: /root/.ssh/*, /home/<user>/.ssh/ (username <= 10 chars) - 95%+ of systems
#   ✗ Misses: /home/very_long_username/.ssh/* (username > 10 chars)
#   ✗ Misses: Custom paths like /data/users/alice/.ssh/*
#   Trade-off: BPF verifier complexity limits vs broad coverage
# Default: true (RECOMMENDED - very low noise, catches credential theft)
monitor_cred_read = true

# Monitor /etc/ld.so.preload writes - T1574.006 LD_PRELOAD Hijacking detection
# Logs: security_ldpreload events
# Detects: Writes to /etc/ld.so.preload (library injection)
# Use case: Detect LD_PRELOAD rootkits that inject into every process
# Note: /etc/ld.so.preload is rarely written legitimately
# Default: true (RECOMMENDED - almost zero noise, critical rootkit detection)
monitor_ldpreload = true

# ============================================================================
# SECURITY MONITORING - OPTIONAL (May generate noise, enable as needed)
# ============================================================================
# These detections can have false positives from legitimate tools.
# DISABLED BY DEFAULT - enable based on your threat model and environment.

# Monitor ptrace() syscall - T1055 Process Injection detection
# Logs: security_ptrace events
# Detects: PTRACE_ATTACH, PTRACE_SEIZE, PTRACE_POKETEXT, PTRACE_POKEDATA
# Use case: Detect process injection, debugger attachment, memory manipulation
# Warning: Legitimate debuggers (gdb, strace, ltrace) will also trigger events
# Recommendation: Enable on high-security systems, review events for anomalies
monitor_ptrace = false

# Monitor kernel module loading - T1547.006 Rootkit/Driver detection
# Logs: security_module_load events
# Detects: init_module(), finit_module() syscalls
# Use case: Detect kernel rootkits, malicious drivers, unauthorized modules
# Note: Only root can load modules, but this detects unauthorized loading
# Recommendation: Enable on production servers, alert on any module load
monitor_modules = false

# Monitor memfd_create() - T1620 Fileless Malware detection
# Logs: security_memfd_create events
# Detects: Creation of anonymous executable memory regions
# Use case: Detect fileless malware, in-memory execution, ELF loaders
# Warning: Some legitimate software uses memfd (containers, JIT compilers)
# Recommendation: Enable on high-security systems, correlate with process exec
monitor_memfd = false

# Monitor bind() syscall - T1571 Bind Shell / C2 Server detection
# Logs: security_bind events
# Detects: Processes binding to network ports (IPv4/IPv6)
# Use case: Detect bind shells, reverse shells, C2 servers, unauthorized services
# Note: Only logs ports > 0 (port 0 = OS assigns ephemeral port)
# Warning: Many legitimate services bind ports (web servers, DBs, etc.)
# Recommendation: Enable and correlate with process name for anomaly detection
monitor_bind = false

# Monitor unshare() syscall - T1611 Container Escape detection
# Logs: security_unshare events
# Detects: Namespace manipulation (CLONE_NEWNS, CLONE_NEWPID, CLONE_NEWUSER, etc.)
# Use case: Detect container escapes, privilege escalation via user namespaces
# Note: Only logs unshare calls with namespace-related flags
# Warning: Container runtimes (Docker, Podman) use unshare legitimately
# Recommendation: Enable on container hosts, alert on unexpected namespace changes
monitor_unshare = false

# Monitor execveat() syscall - T1620 Fileless Execution detection
# Logs: security_execveat events
# Detects: fd-based execution (executing from file descriptor instead of path)
# Use case: Detect fileless malware using memfd_create() + execveat() pattern
# Note: AT_EMPTY_PATH flag indicates truly fileless execution
# Warning: Some legitimate tools use execveat (fexecve wrapper)
# Recommendation: Enable on high-security systems, correlate with memfd events
monitor_execveat = false

# Monitor bpf() syscall - T1014 eBPF Rootkit detection
# Logs: security_bpf events
# Detects: BPF program loading, map creation, BTF loading
# Use case: Detect eBPF-based rootkits, packet manipulation, syscall hiding
# Note: Only logs BPF_PROG_LOAD, BPF_MAP_CREATE, BPF_BTF_LOAD commands
# Warning: System tools using eBPF will trigger (bpftool, tc, ip, bcc tools)
# Recommendation: Enable on high-security systems, whitelist known tools
monitor_bpf = false

# Monitor persistence mechanisms - T1053, T1547 Persistence detection
# Logs: security_persistence events
# Detects: Writes to cron, systemd services, shell profiles, init scripts, autostart
# Locations: /etc/cron.d/*, /var/spool/cron/*, /etc/systemd/system/*,
#            /usr/lib/systemd/system/*, ~/.bashrc, ~/.profile, ~/.zshrc,
#            ~/.config/autostart/*, /etc/rc.local, /etc/init.d/*
# Use case: Detect attackers establishing persistence after compromise
# Warning: Legitimate admin tasks write to these locations
# Recommendation: Enable on production servers, correlate with user activity
# persistence_type values: cron, systemd, shell_profile, init, autostart
# Known limitation: Shell profiles only detected if /.bashrc etc occurs within first 38 chars
#   ✓ Covers: /root/.bashrc, /home/<user>/.bashrc (username <= 16 chars) - 95%+ of systems
#   ✓ Covers: All /etc/* and /var/* paths (always detected)
#   ✗ Misses: /home/very_long_username/.bashrc (username > 16 chars)
#   ✗ Misses: Custom paths like /data/users/alice/.bashrc
#   Trade-off: BPF verifier complexity limits vs broad coverage
monitor_persistence = false

# Monitor SUID/SGID manipulation - T1548.001 Privilege Escalation detection
# Logs: security_suid events
# Detects: chmod operations that set SUID (04000) or SGID (02000) bits
# Use case: Detect privilege escalation setup (chmod +s for persistent root access)
# Note: Legitimate package managers may set SUID on some binaries
# Warning: Low noise - SUID changes are rare, mostly during package installs
# Recommendation: Enable on high-security systems, alert on unexpected paths
# Event fields: path, mode (full mode bits), suid (true/false), sgid (true/false)
monitor_suid = false

# Monitor credential file WRITES - T1098.001 Account Manipulation detection
# Logs: security_cred_write events
# Detects: Writes to /etc/passwd, /etc/shadow, /etc/sudoers, ~/.ssh/authorized_keys, etc.
# Use case: Detect account creation, password changes, privilege escalation, SSH backdoors
# Files monitored: /etc/shadow, /etc/gshadow, /etc/sudoers, /etc/sudoers.d/*,
#                  /etc/ssh/* (system SSH config), /etc/pam.d/* (PAM config),
#                  ~/.ssh/id_* (private keys), ~/.ssh/authorized_keys, ~/.ssh/config
# Warning: Very low noise - credential file writes are rare outside package installs
# Recommendation: Enable by default (true) - critical detection with minimal noise
# Event fields: cred_file (shadow/sudoers/ssh_authorized_keys/etc), path, open_flags
monitor_cred_write = true

# Monitor log file tampering - T1070.001 Log Clearing / Anti-Forensics detection
# Logs: security_log_tamper events
# Detects: Truncation or deletion of files in /var/log/*
# Use case: Detect attackers covering their tracks (> /var/log/auth.log, rm /var/log/*)
# Smart filtering: Whitelists legitimate log managers (logrotate, rsyslogd, systemd-journal, auditd, linmond)
# Warning: Very low noise - log tampering by non-whitelisted processes is almost always malicious
# Recommendation: Enable by default (true) - critical detection with minimal noise
# Event fields: tamper_type (truncate/delete), path, open_flags (for truncate)
monitor_log_tamper = true

# Monitor raw disk access - T1561.001/002 Disk Wipe detection
# Logs: raw_disk_access events
# Detects: Write access to raw block devices (dd, shred, wipefs, ransomware disk wipers)
# Monitored devices: /dev/sd*, /dev/nvme*, /dev/vd*, /dev/xvd*, /dev/md*, /dev/dm-*, /dev/loop*
# Use case: Detect destructive attacks that wipe disks (ransomware final stage, sabotage, anti-forensics)
# Examples: dd if=/dev/zero of=/dev/sda, shred /dev/nvme0n1, ransomware wiping MBR/GPT
# Warning: Low noise - normal applications rarely write directly to raw devices
# Note: Legitimate use cases exist (disk imaging tools, system installers, disk encryption setup)
# Recommendation: Enable by default (true) - critical detection, review alerts carefully
# Event fields: device (e.g., /dev/sda), open_flags, write_access (boolean)
monitor_raw_disk_access = true
