# ============================================================================
# LinMon Remote Syslog Forwarding Configuration
# ============================================================================
#
# This rsyslog configuration forwards LinMon daemon events to a remote
# syslog server for tamper-resistant audit trails.
#
# Installation:
#   sudo cp rsyslog-remote.conf /etc/rsyslog.d/10-linmon-remote.conf
#   sudo systemctl restart rsyslog
#
# ============================================================================

# Forward LinMon daemon events to remote syslog server
# Replace <REMOTE_SERVER> and <PORT> with your actual values
#
# Protocols:
#   @@  = TCP (reliable, recommended for audit logs)
#   @   = UDP (faster, but can lose messages)
#
# Standard ports:
#   514 = Traditional syslog (unencrypted)
#   6514 = TLS-encrypted syslog (requires rsyslog-gnutls)

# Example: Forward to remote server via TCP
if $programname == 'linmond' then @@remote-syslog-server.example.com:514

# Example: Forward to remote server via UDP (less reliable)
# if $programname == 'linmond' then @remote-syslog-server.example.com:514

# Example: Forward to remote server via TLS (encrypted, requires rsyslog-gnutls)
# if $programname == 'linmond' then @@remote-syslog-server.example.com:6514

# Optional: Also save locally (default behavior)
# Remove this line to ONLY send to remote server (not recommended)
# & ~

# ============================================================================
# What Gets Forwarded
# ============================================================================
#
# LinMon logs the following events to syslog (all tagged with programname="linmond"):
#
# 1. Daemon Lifecycle Events (ALWAYS logged to syslog):
#    - daemon_start: Daemon startup with version, daemon SHA256, config SHA256
#    - daemon_reload: Config reload (SIGHUP) with sender info and integrity hashes
#    - daemon_shutdown: Graceful shutdown with signal sender info
#
# 2. Periodic Checkpoints (if checkpoint_interval > 0 in linmon.conf):
#    - checkpoint: Every N minutes with sequence number, event count, uptime,
#                  daemon SHA256, config SHA256
#    - Default: Every 30 minutes
#    - Use to detect: Deleted events (gaps in sequence), binary tampering,
#                     config tampering, daemon interruptions
#
# 3. All Events (if log_to_syslog = true in linmon.conf):
#    - process_exec, process_exit, file_*, net_*, priv_*, security_*
#    - Warning: Can generate significant syslog volume on busy systems
#    - Default: false (only daemon events and checkpoints go to syslog)
#
# ============================================================================
# Tamper Detection with Remote Syslog
# ============================================================================
#
# Remote syslog provides defense-in-depth against log tampering:
#
# 1. Separate Storage:
#    - Attacker who compromises host cannot easily delete remote logs
#    - Provides independent audit trail
#
# 2. Sequence Number Gaps:
#    - Checkpoints show monotonic sequence numbers
#    - Deleted local events → gap in sequence numbers visible in checkpoints
#    - Example: Local log shows seq 100, 101, 200, 201 (events 102-199 deleted)
#                Remote syslog checkpoints show: seq=150 at time T, seq=250 at T+30min
#                → 100 events missing from local log
#
# 3. Integrity Hash Changes:
#    - daemon_sha256: Detects if linmond binary is replaced
#    - config_sha256: Detects if config is modified without SIGHUP
#    - Compare hashes across checkpoints to detect tampering
#
# 4. Daemon Interruptions:
#    - Gap in checkpoints (no checkpoint for >30 minutes) = daemon was stopped
#    - daemon_shutdown logs who stopped it (signal sender PID/UID)
#
# 5. Event Count Verification:
#    - Checkpoint "events" field = total events logged
#    - Compare to actual event count in JSON log
#    - Mismatch = events deleted from JSON log
#
# ============================================================================
# Example Queries on Remote Syslog Server
# ============================================================================
#
# View all LinMon daemon events:
#   journalctl -t linmond
#   grep 'linmond' /var/log/syslog
#
# View checkpoints only:
#   journalctl -t linmond | grep checkpoint
#
# Detect sequence gaps:
#   journalctl -t linmond | grep checkpoint | awk '{print $NF}' | grep seq=
#   # Look for non-sequential sequence numbers
#
# Detect integrity changes:
#   journalctl -t linmond | grep checkpoint | grep daemon_sha256
#   # Compare hashes across time - changes indicate binary replacement
#
# Detect unauthorized config changes:
#   journalctl -t linmond | grep checkpoint | grep config_sha256
#   # Compare hashes - changes without daemon_reload = unauthorized modification
#
# View daemon restarts:
#   journalctl -t linmond | grep -E '(daemon_start|daemon_shutdown)'
#   # Shows when daemon was stopped/started and by whom
#
# ============================================================================
# Security Hardening (Optional)
# ============================================================================
#
# 1. TLS Encryption (protect logs in transit):
#    sudo apt-get install rsyslog-gnutls
#    # Configure TLS certificates and use @@server:6514
#
# 2. Firewall Rules (only allow rsyslog to remote server):
#    sudo ufw allow out to <remote-syslog-server> port 514 proto tcp
#
# 3. Immutable Remote Storage:
#    # On remote syslog server, make logs immutable
#    sudo chattr +a /var/log/remote/linmond.log
#
# 4. SIEM Integration:
#    # Forward to SIEM for alerting on:
#    # - Sequence number gaps
#    # - Integrity hash changes
#    # - Unexpected daemon shutdowns
#    # - Gaps in checkpoints
#
# ============================================================================
